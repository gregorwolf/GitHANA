<!DOCTYPE html>
<meta charset="utf-8">
<html class="no-js">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Git <> HANA</title>
        <script src="lib/base64.js"></script>
        <script src="lib/jquery.min.js"></script>
        <script src="lib/underscore-min.js"></script>
        <script src="lib/github.js"></script>
        <script src="lib/difflib.js"></script>
        <script src="lib/diffview.js"></script>
        <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"/>
        <link rel="stylesheet" type="text/css" href="css/diffview.css"/>
        <link rel="stylesheet" type="text/css" href="css/style.css"/>
        <link rel="stylesheet" type="text/css" href="css/font-awesome.min.css"/>
        
        
        <script type="text/javascript">
        var HanaRepoService = "http://metric2.us.to:8000/sap/hana/xs/ide/editor/server/repo/reposervice.xsjs"; /* SPS07 - http://yourserver:8000/sap/hana/xs/ide/editor/server/repo/reposervice.xsjs */
        var HanaCSRFService = "http://metric2.us.to:8000/sap/hana/xs/ide/editor/server/csrf.xsjs"
        var HanaPackage = "lilabs/metric2/";       /*    lilabs/metric2/    */
        var gitUsername = "yourusername";
        var gitPassword = "yourpassword";

        var csrf;
        var repo;    
        var hanaData;
        var gitData;
        var selectedViewType;
            
        var github;
        
        $(function() {
            init();
        });
        
        function init(){
            github = null;
            github = new Github({
              username: gitUsername,
              password: gitPassword,
              auth: "basic"
            });
            loadRepoList();
            $('#hanapackage').val(HanaPackage);
            
            loadHanaPackageContents(HanaPackage, $('#hanasystem'));
            
            $("#sysTabs a").click(function(e){
    	        e.preventDefault();
    	        $(this).tab('show');
            });
            
            $('#btnSideBar').click(function(e){
                if ($('#logoarea').css("display") == "block"){
                    $('#logoarea').css("display", "none");
                    $('#main').css("margin-left","0");
                    $('#header .tools-bar').css("margin-left","0");
                } else {
                    $('#logoarea').css("display", "block");
                    $('#main').css("margin-left","270px");
                    $('#header .tools-bar').css("margin-left","250px");
                }
            });
            
            $(document).on("click", ".hanafolder", function(event) {
                        event.stopPropagation();
                        if ($(this).children().find('li').length > 0){
                            $(this).children().find('li').remove();
                        } else {
                            loadHanaPackageContents($(this).data('ref'), $(this));
                        }
            });
                    
            $(document).on("click", ".hanapage", function(event) {
                        event.stopPropagation();
                        clearResults();
                        var filename = $(this).data('ref');
                        getFile(filename);
                        //compareFiles(selectedViewType);
            });
            
            $(document).on("click", ".folder", function(event) {
                $(this).next('ul').find('> li').slideToggle('slow');
            });
            
            $(document).on("click", ".page", function(event) {
                event.stopPropagation();
                clearResults();
                    var filename = $(this).data('ref');
                    getFile(filename);
                    //compareFiles(selectedViewType);
                });
            
        }
        
        function loadRepoList(){
            var user = github.getUser();
            user.repos(function(err, repos) {
                var s = $('<select id="GitRepo" />');
                $('<option />', {value: "", text: ""}).appendTo(s);
                $.each(repos, function(key, value) {
                    $('<option />', {value: value.name, text: value.name}).appendTo(s);
                });
                
                s.appendTo('#cboRepo');
                
                s.change(function() {
                    $('#filesystem').html('');
                    //loadRepoContents($(this).val());
                    loadRepoBranchList($(this).val());
                });
                
            });
        }
        
        function loadRepoBranchList(repoName){
            repo = github.getRepo(gitUsername, repoName);
            repo.listBranches(function(err, branches) {
                $('#cboBranch').html('');
                var s = $('<select id="RepoBranch" />');
                $('<option />', {value: "", text: ""}).appendTo(s);
                $.each(branches, function(key, value) {
                    $('<option />', {value: value, text: value}).appendTo(s);
                });
                
                s.appendTo('#cboBranch');
                
                s.change(function() {
                    $('#filesystem').html('');
                    loadRepoContents($('#GitRepo').val(), $(this).val());
                });
            });
        }
            
        function loadRepoContents(repoName, repoBranch){
            repo = github.getRepo(gitUsername, repoName);
            repo.getTree(repoBranch + '?recursive=true', function(err, tree) {
                var depth = 0;
                var foldername = "";
                var html = "";
                tree.forEach(function(obj) {
                    var parser = document.createElement('a');
                    parser.href = obj.path;
                    
                    if (obj.path.split("/").length > depth){
                        html += "<ul>";
                    } else if (obj.path.split("/").length < depth) {
                        var diff = depth - obj.path.split("/").length;
                        for (var i = 1; i <= diff; i++){
                            html += "</ul>";
                        }
                    } 
                    depth = obj.path.split("/").length;
                    foldername = parser.pathname;
                    
                    var vis = (depth > 1 ? "none" : "");
                        
                    if (obj.type == "tree"){
                        html += "<li class='folder' data-id='0' style='display: " + vis + "'><i class='fa fa-folder'></i><a href='#'>  " + obj.path.split("/").slice(obj.path.split("/").length - 1) + "</a></li>";
                    } else {
                        html += "<li class='page' data-id='1' style='display: " + vis + "' data-ref='" + obj.path + "'><i class='fa fa-file-code-o'></i><a href='#'>  " + obj.path.split("/").slice(obj.path.split("/").length - 1) + "</a></li>";
                    }
                });
                
                $('#filesystem').html(html);
                
                
            });
        }
        
        function loadHanaPackageContents(path, obj){
            if (path.substring(path.length - 1, path.length) == "/"){
                path = path.substring(0, path.length - 1);
            }
            $.ajax({
                type: "GET",
                //contentType: "text/plain; charset=UTF-8",
                //headers: { 'X-CSRF-Token': csrf, 'activate': activate },
                url: HanaRepoService + "?path=" + path,
                success: function (files) {
                    var depth = 0;
                    var foldername = "";
                    var html2 = "";
                        
                    $.each(files.children, function(obj) {
                        var parser = document.createElement('a');
                        parser.href = files.children[obj].uri;
                            
                        if (files.children[obj].uri.split("/").length > depth){
                            html2 += "<ul>";
                        } else if (files.children[obj].uri.split("/").length < depth) {
                            var diff = depth - files.children[obj].uri.split("/").length;
                            for (var i = 1; i <= diff; i++){
                                html2 += "</ul>";
                            }
                        } 
                        depth = files.children[obj].uri.split("/").length;
                        foldername = parser.pathname;
                                
                        var vis = 'block'; //(depth > 1 ? "none" : "");
                                var relativepath = files.children[obj].uri.replace(HanaPackage,'');
                        if (files.children[obj].rel == "folder"){
                            html2 += "<li class='hanafolder' data-id='0' style='display: " + vis + "' data-ref='" + HanaPackage + relativepath + "'><i class='fa fa-folder'></i><a href='#'>  " + files.children[obj].uri.split("/").slice(files.children[obj].uri.split("/").length - 1) + "</a></li>";
                        } else {
                            
                            html2 += "<li class='hanapage' data-id='1' style='display: " + vis + "' data-ref='" + relativepath + "'><i class='fa fa-file-code-o'></i><a href='#'>  " + relativepath + "</a></li>";
                        }
                    });
            
                    html2 += "</ul>";
                    
                    $("#loadspinner").css('display','none');
                    $(obj).append(html2);
                            
                    
                    
                },
                error: function (err){
                    $("#loadspinner").css('display','none');
                }
            });
        }
        
        
        function getFile(filename){
            $('#filename').html(filename);
            HanaPackage = $('#hanapackage').val();
            var hanafilename;
            
            if (filename.indexOf("_.") > -1){
                //this converts a github filename of e.g. _.xsaccess.html to .xsaccess
                hanafilename = "." + filename.split(".")[1];
            } else if (filename.indexOf(".") == 0){
                //this converts a hana filename of e.g. .xsaccess to _.xsaccess.html
                hanafilename = filename;
                filename = "_" + filename + ".html";
            } else {
                hanafilename = filename;
            }
            
            if (typeof repo === 'undefined'){
                alert("Please select a Github repository");
            } else {
                var isimg = false;
                
                if ((/\.(gif|jpg|jpeg|tiff|png)$/i).test(filename)){
                    var img = $('<img id="gitimg">');
                    img.attr('src', 'https://raw.githubusercontent.com/' + gitUsername + '/' + $('#GitRepo').val() + '/' + $('#RepoBranch').val() + '/' + filename);
                    var img2 = $('<img id="hanaimg">');
                    img2.attr('src', '/' + HanaPackage +  hanafilename);
                    $('#results').html('<table id="imgTable"><tr><td class="center">Hana</td><td class="center">Github</td></tr><tr><td id="img1" class="center"></td><td id="img2" class="center"></td></tr></table>');
                    $('#img1').html(img2);
                    $('#img2').html(img);
                    isimg = true;
                }
                
                    $("#loadspinner").css('display','block');
                    $.get( HanaRepoService + "?path=" + HanaPackage +  hanafilename, function( data1 ) {
                        hanaData = data1;
                        repo.read($('#RepoBranch').val(), filename, function(err, data2) {
                            if (err != null){
                                gitData = "Error getting file from Github Repository, please check file exists.";
                            } else {
                                gitData = data2;
                            }
                            $('#btn1').show();
                            $('#btn2').show();
                            if (!isimg){
                                compareFiles(0);
                            }
                            $("#loadspinner").css('display','none');
                        });
                    }).fail(function() {
                        hanaData = 'Error getting file from HANA Repository, please check file exists.';
                        repo.read($('#RepoBranch').val(), filename, function(err, data2) {
                            gitData = data2;
                            $('#btn1').show();
                            if (!isimg){
                                compareFiles(0);
                            }
                            $("#loadspinner").css('display','none');
                            $('#btn2').hide();
                        });
        
                    });
            }
        }
                
        
        function saveToGitHub(){
            var r = confirm("Are you sure you want to commit this file to your Github repository?");
            if (r == true) {
                var comment = prompt("Please enter a comment", "Update " + $('#filename').html());
                if (comment != null) {
                    $("#loadspinner").css('display','block');
                    repo.write($('#RepoBranch').val(), $('#filename').html(), hanaData, comment, function(err) {
                        $("#loadspinner").css('display','none');
                        getFile($('#filename').html());
                        loadRepoContents($('#GitRepo').val(), $('#RepoBranch').val());
                    });
                }
            }
        }
        
        function compareFiles(viewType) {
        	"use strict";
        	var byId = function (id) { return document.getElementById(id); },
        		base = difflib.stringAsLines(hanaData),
        		newtxt = difflib.stringAsLines(gitData),
        		sm = new difflib.SequenceMatcher(base, newtxt),
        		opcodes = sm.get_opcodes(),
        		diffoutputdiv = byId("results"),
        		contextSize = null;
        
            selectedViewType = viewType;
        	diffoutputdiv.innerHTML = "";
        	contextSize = contextSize || null;
        
        	diffoutputdiv.appendChild(diffview.buildView({
        		baseTextLines: base,
        		newTextLines: newtxt,
        		opcodes: opcodes,
        		baseTextName: "HANA File",
        		newTextName: "Github File",
        		contextSize: contextSize,
        		viewType: viewType
        	}));
        }
        
        function showSettings(){
            $('#modal-header').html("Settings");
            $('#dialogHTML1').css('height','auto');
            $('#modaldlg').css('height','auto');
            $('#modaldlg').css('width','720px');
            $('#myModal').appendTo("body").modal('show');
            
            $('#txtGithubusername').val(gitUsername);
            $('#txtGithubpassword').val(gitPassword);
            $('#txtRepoService').val(HanaRepoService);
            $('#txtPackage').val(HanaPackage);
        }
        
        function saveDialog(){
            if ($('#modal-header').html().indexOf('Settings') > -1)
            {
                gitUsername = $('#txtGithubusername').val();
                gitPassword = $('#txtGithubpassword').val();
                HanaRepoService = $('#txtRepoService').val();
                HanaPackage = $('#txtPackage').val();
                $('#hanapackage').val(HanaPackage);
                $('#myModal').modal('hide');
                clearFileSystem();
                init();
            } else {
                var r = confirm("Are you sure you want to commit these files to your local HANA package?");
                if (r == true) {
                    downloadAllFromGithub();
                } else {
                    $('#myModal').modal('hide');
                }
            }
        }
        
        function clearResults(){
            $('#results').html('');
            hanaData = "";
            gitData = "";
        }
        
        function clearFileSystem(){
            $('#filesystem').html('');
            $('#filename').html('');
            $('#cboBranch').html('');
            $('#cboRepo').html('');
            $('#hanasystem').html('');
        }
        
        function saveConfirm(){
            var r = confirm("Are you sure you want to commit this file to your HANA Package? This will overwrite your local file if it exists!");
            if (r == true) {
                saveToHana(gitData, $('#filename').html(), 'file');
            }
        }
        
        /* v2 Feature */
        function saveToHana(data, path, type){
                $("#loadspinner").css('display','block');
                 
                $.ajax({
                    type: "HEAD",
                    headers: { 'X-CSRF-Token': 'Fetch' },
                    url: HanaCSRFService,
                    success: function(res, status, xhr) { 
                        csrf = xhr.getResponseHeader("X-CSRF-Token");
                        if (path.indexOf("_.") > -1){
                            path = "." + path.split(".")[1];
                        } else {
                            path = path;
                        }
                        var activate = 'true';
                        if (type == 'tree'){
                            activate = 'false';
                        }
                        $.ajax({
                            type: "PUT",
                            contentType: "text/plain; charset=UTF-8",
                            headers: { 'X-CSRF-Token': csrf, 'activate': activate },
                            url: HanaRepoService + "?path=" + HanaPackage +  path,
                            data: data,
                            success: function (msg) {
                                $("#loadspinner").css('display','none');
                                //reload HANA file system
                            },
                            error: function (err){
                                $("#loadspinner").css('display','none');
                            }
                        });
                    },
                    error: function (err){
                        $("#loadspinner").css('display','none');
                    }
                });
        }
        
        
        function downloadGit(){
            $('#modal-header').html("Download Git Repository to HANA");
            $('#dialogHTML1').html("Click save to start the transfer.");
            $('#dialogHTML1').css('height','auto');
            $('#modaldlg').css('height','auto');
            $('#modaldlg').css('width','720px');
            $('#myModal').appendTo("body").modal('show');
        }
        
        function downloadAllFromGithub(){
            repo = github.getRepo(gitUsername, $('#GitRepo').val());
                    repo.getTree($('#RepoBranch').val() + '?recursive=true', function(err, tree) {
                        tree.forEach(function(obj) {
                                repo.read($('#RepoBranch').val(), obj.path, function(err, data2) {
                                    saveToHana(data2, obj.path, obj.type)
                                });
                        });
                    });
        }
        
        </script>
        
    </head>

<body>
    <div id="wrapper">
        <div id="header">
            <div id="logoarea" class="logo-area">
                <img src="img/logo.png" />
            </div>
        
            <div class="tools-bar">
                <ul class="nav navbar-nav nav-main-xs">
                    <li><a href="#sidebar" id="btnSideBar" class="icon-toolsbar"><i class="fa fa-bars"></i></a></li>
                    <li><a href="#"><span id="filename"></span></a></li>
                </ul>
        
                <ul class="nav navbar-nav navbar-right tooltip-area">
                    <li class="hidden-xs hidden-sm"><a href="../../sap/hana/xs/ide/editor/" target="_blank" id="btnInline" title="Open Editor"><i class="fa fa-list-alt"></i></a></li>
                    <li class="hidden-xs hidden-sm" id="btn1"><a href="#" onClick="saveConfirm();" id="btnSaveToHana" class="h-seperate" title="Commit Github file to HANA"><i class="fa fa-dropbox"></i> <i class="fa fa-angle-right"></i> <i class="fa fa-save"></i></a></li>
                    <li class="hidden-xs hidden-sm" id="btn2"><a href="#" onClick="saveToGitHub();" id="btnSaveToGit" class="h-seperate" title="Commit HANA file to Github"><i class="fa fa-save"></i> <i class="fa fa-angle-right"></i> <i class="fa fa-git"></i></a></li>
                    <li class="hidden-xs hidden-sm"><a href="#" onclick="compareFiles(0);" id="btnSidetoSide" class="h-seperate" onClick="" title="Compare Side by Side"><i class="fa fa-columns"></i></a></li>
                    <li class="hidden-xs hidden-sm"><a href="#" onclick="compareFiles(1);" id="btnInline" class="h-seperate" title="Compare Inline"><i class="fa fa-align-justify"></i></a></li>
                    <li class="hidden-xs hidden-sm"><a href="#" onclick="showSettings();" id="btnInline" class="h-seperate" title="Compare Inline"><i class="fa fa-gear"></i></a></li>
                    <!-- Version 2 feature experimental 
                    <li class="hidden-xs hidden-sm"><a href="#" onclick="downloadGit();" id="btnInline" class="h-seperate" title="Download Repository to HANA"><i class="fa fa-git"></i> <i class="fa fa-cloud-download"></i></a></li>
                    -->
                </ul> <!-- //nav-bar-->
            </div> <!-- //tools-bar-->
        </div> <!-- //header-->
        
        <div id="nav">
            <div id="nav-scroll">
                <!-- Show dropdowns of Github repos and HANA -->
                <ul class="nav nav-tabs" id="sysTabs">
                    <li class="active"><a href="#hana">HANA Package</a></li>
                    <li><a href="#git">Github Repo</a></li>
                </ul>
                 <div class="tab-content">
                    <div id="hana" class="tab-pane fade in active">
                        <div id="navstep">HANA Package:</div>
                            <div class="input-group">
                                <input type="text" id="hanapackage" class="form-control" disabled/>
                                <span class="input-group-addon"  onclick="showSettings();"><i class="fa fa-gear"></i></span>
                            </div><!-- /input-group -->
                        
                        <hr>
                        <ul id="hanasystem"></ul>
                    </div>
                    <div id="git" class="tab-pane fade">
                        <div id="navstep">Github Repository:</div>
                        <div id="cboRepo"></div><br />
                        <div id="navstep">Repository Branch:</div>
                        <div id="cboBranch"></div>
                        <hr>
                        <ul id="filesystem"></ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="main">
                    <div id="loadspinner" class="loading" >
                        <!-- We make this div spin -->
                        <div class="spinner">
                            <!-- Mask of the quarter of circle -->
                            <div class="mask">
                                <!-- Inner masked circle -->
                                <div class="maskedCircle"></div>
                            </div>
                        </div>
                    </div>
            <div id="results"></div>
        </div>
        
            <div id="modaldialog" style="bottom: 0;"></div>
            <div id="myModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modal-header" aria-hidden="true">
                <div id="modaldlg" class="modal-dialog">
                    <div class="modal-content" style="height: 100%; width: 100%;">
                        <div class="modal-header">
                            <button id="btnModalX" type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="modal-header">Settings</h4>
                        </div>
                        <div id="dialogMsg1"></div>
                        <div id="dialogHTML1" class="modal-body">
                            <form role="form">
                                <div class="form-group">
                                    <label for="txtGithubusername">Github Username</label>
                                    <input type="username" class="form-control" id="txtGithubusername" placeholder="Username">
                                </div>
                                <div class="form-group">
                                    <label for="txtGithubpassword">Password</label>
                                    <input type="password" class="form-control" id="txtGithubpassword" placeholder="Password">
                                </div>
                                <div class="form-group">
                                    <label for="txtRepoService">HANA Repo Service URL</label>
                                    <input type="hanareposvc" class="form-control" id="txtRepoService" placeholder="URL to the RepoService.xsjs file">
                                </div>
                                <div class="form-group">
                                    <label for="txtPackage">HANA Package Name</label>
                                    <input type="hanapackage" class="form-control" id="txtPackage" placeholder="HANA Package Path">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button id="btnModalClose" type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button id="btnModalDownload" onclick="saveDialog();" type="button" class="btn btn-primary" >Save</button>
                        </div>
                    </div>
                </div>
            </div> <!-- //myModal --> 
        
    </div> <!-- //wrapper -->
</body>
</html>
